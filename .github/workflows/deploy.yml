name: Deploy Pages

# 触发条件：push 到 master 分支，pull request 到 master，或手动触发
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

# 设置时区
env:
  TZ: Asia/Shanghai

# 权限设置
permissions:
  contents: read  # 允许读取仓库内容
  pages: write    # 允许写入 GitHub Pages
  id-token: write # 允许写入 ID Token

# 定义任务
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 拉取代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 保留完整的 Git 历史记录

      # 设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 安装最新的 pnpm
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
          run_install: false

      # 安装依赖
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      # 构建项目
      - name: Build project
        run: pnpm build

      # 构建静态资源
      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./docs/.vitepress/dist
          destination: ./_site

      # 调试构建输出（可选，方便排查问题）
      - name: Debug build output
        run: ls -al ./_site

      # 上传构建的静态文件
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

  deploy:
    runs-on: ubuntu-latest
    needs: build  # 确保先构建后部署
    steps:
      # 下载构建的静态文件
      - name: Download artifact
        uses: actions/download-pages-artifact@v3
        with:
          path: ./_site

      # 部署到 GitHub Pages
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
