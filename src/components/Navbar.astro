---
import NavbarLink from './NavbarLink.astro'
import { Icon } from 'astro-icon/components'
import ThemeSelector from './ThemeSelector.astro'
import { SITE_BASE, WebsiteLinks } from '../consts'
import LogoSVG from '../assets/logo.svg'
---

<header class="fixed top-0 w-full z-40 bg-background dark:bg-background-dark">
	<!-- 顶部彩虹装饰条 -->
	<div class="h-1 rainbow-bg"></div>
	<nav class="">
		<div class="app-container flex justify-between items-center py-5">
			<a
				href={`${SITE_BASE}/`}
				aria-label="Home"
				class="flex items-center gap-3 group"
			>
				<LogoSVG height={36} width={36} />
				<!-- 小马里奥星星装饰 -->
				<div
					class="mario-star hidden sm:block"
					style="width: 16px; height: 16px; opacity: 0; transition: opacity 0.3s;"
				>
				</div>
			</a>
			<div class="gap-8 hidden md:flex items-center">
				{
					WebsiteLinks.map((link) => (
						<NavbarLink
							class="text-lg nav-link-nintendo"
							href={link.url}
							target={link.url.charAt(0) === 'h' ? '_blank' : '_self'}
						>
							{link.name}
						</NavbarLink>
					))
				}
				<ThemeSelector />
				<!-- 导航栏金币装饰 -->
				<div class="mario-coin" style="width: 20px; height: 20px;"></div>
			</div>
			<button
				class="md:hidden cursor-pointer"
				id="nav-open-btn"
				aria-label="Open navigation menu"
				title="Open navigation menu"
			>
				<Icon aria-hidden name="mdi:menu" size={32} />
			</button>

			<!-- Mobile nav -->
			<div
				class="translate-x-full md:hidden fixed top-0 right-0 bg-background dark:bg-background-dark h-screen w-5/6 px-8 py-6 transition-transform z-40 border-l-[1px] border-background"
				id="mobile-menu"
			>
				<button
					id="nav-close-btn"
					class="ml-auto block cursor-pointer"
					aria-label="Close navigation menu"
					title="Close navigation menu"
				>
					<Icon aria-hidden name="mdi:close" size={32} />
				</button>
				<div class="flex flex-col h-full items-start gap-8 pt-16">
					{
						WebsiteLinks.map((link) => (
							<NavbarLink
								class="text-4xl font-light"
								href={`${SITE_BASE}/${link.url}`}
							>
								{link.name}
							</NavbarLink>
						))
					}
					<ThemeSelector class:list="mt-4" />
					<!-- 移动端菜单底部游戏元素装饰 -->
					<div class="flex gap-4 mt-auto mb-24">
						<div class="mario-star" style="width: 24px; height: 24px;"></div>
						<div class="zelda-heart" style="width: 24px; height: 21px;"></div>
						<div class="mario-coin" style="width: 24px; height: 24px;"></div>
					</div>
				</div>
			</div>
		</div>
	</nav>

	<script>
		function toggleNav() {
			document
				.querySelector('#mobile-menu')
				?.classList.toggle('mobile-nav-open')
		}

		document
			.querySelector('#nav-open-btn')
			?.addEventListener('click', toggleNav)
		document
			.querySelector('#nav-close-btn')
			?.addEventListener('click', toggleNav)

		// Logo hover 显示星星
		const logoLink = document.querySelector('a[aria-label="Home"]')
		const star = logoLink?.querySelector('.mario-star')
		if (logoLink && star) {
			logoLink.addEventListener('mouseenter', () => {
				;(star as HTMLElement).style.opacity = '1'
			})
			logoLink.addEventListener('mouseleave', () => {
				;(star as HTMLElement).style.opacity = '0'
			})
		}
	</script>
</header>

<style>
	/* 导航链接任天堂风格悬停效果 */
	:global(.nav-link-nintendo) {
		position: relative;
		transition: color 0.3s ease;
		text-decoration: none !important;
	}

	:global(.nav-link-nintendo:hover) {
		text-decoration: none !important;
	}

	:global(.nav-link-nintendo.active) {
		text-decoration: none !important;
	}

	:global(.nav-link-nintendo::after) {
		content: '';
		position: absolute;
		bottom: -4px;
		left: 0;
		width: 0;
		height: 3px;
		background: linear-gradient(
			90deg,
			var(--color-primary),
			var(--color-accent-2)
		);
		border-radius: 2px;
		transition: width 0.3s ease;
	}

	:global(.nav-link-nintendo:hover::after),
	:global(.nav-link-nintendo.active::after) {
		width: 100%;
	}
</style>

<script is:inline>
	function reComputeTheme() {
		if (
			localStorage.theme === 'dark' ||
			(!('theme' in localStorage) &&
				window.matchMedia('(prefers-color-scheme: dark)').matches)
		) {
			document.documentElement.classList.add('dark')
		} else {
			document.documentElement.classList.remove('dark')
		}

		const theme = localStorage.theme || 'auto'
		document
			.querySelectorAll(`[data-theme="theme-${theme}"]`)
			.forEach((el) => el.classList.add('active'))
	}

	function addThemeEventListeners() {
		themeButtons = document.querySelectorAll('.theme-button')
		themeButtons.forEach((button) => {
			button.addEventListener('click', () => {
				themeButtons.forEach((btn) => btn.classList.remove('active'))
				button.classList.add('active')
				if (button.dataset.theme === 'theme-auto') {
					localStorage.removeItem('theme')
					reComputeTheme()
				} else {
					localStorage.theme = button.dataset.theme.replace('theme-', '')
					document.documentElement.classList.toggle(
						'dark',
						button.dataset.theme === 'theme-dark'
					)
				}
			})
		})
	}

	// Set active class on OS theme change
	window
		.matchMedia('(prefers-color-scheme: dark)')
		.addEventListener('change', (_e) => {
			reComputeTheme()
		})

	// run recomputeTheme when screen crosses 768px
	window.matchMedia('(min-width: 768px)').addEventListener('change', (_e) => {
		addThemeEventListeners()
		reComputeTheme()
	})

	reComputeTheme()

	// Run on page load
	window.addEventListener('DOMContentLoaded', () => {
		addThemeEventListeners()
		reComputeTheme()
	})
</script>
